# Continuous Integration (CI) Actions for mirroring GitHub repos into Bitbucket
#
# References: 
# - https://claude.ai/share/3d77d63e-2160-491a-b782-7f9d8524237a
# - https://maxschmitt.me/posts/github-actions-ssh-key
# - https://github.com/marketplace/actions/webfactory-ssh-agent

name: Mirror to Bitbucket

on:
  push:
    branches:
      - '**'   # Triggers on pushes to any branch
    tags:
      - '**'   # Triggers on any tag push
      
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  mirror:
    name: Mirror Push to Bitbucket
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the full repo history (not a shallow clone)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history is required for a proper mirror

      # Step 2: Set up the SSH agent and load the private key
      - name: Set up SSH Agent
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
          
        run: |
        
          mkdir -p ~/.ssh
          
          echo "${{ secrets.BITBUCKET_SSH_PRIVATE_KEY }}" > ~/.ssh/github_actions
          chmod 600 ~/.ssh/github_actions
          
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add ~/.ssh/github_actions
        
      # Step 3: Add Bitbucket's host key to known_hosts
      # chmod 600 — Strictly private — only the owner can read or write
      - name: Add Bitbucket to Known Hosts
        run: |
        
          ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts 

      # Step 4: Push all branches and tags to the corresponding Bitbucket repo
      - name: Push to Bitbucket 
        env: 
          WORKSPACE_NAME: "just-noticeable"         
          
        run: |
  
          echo "Bitbucket workspace name: ${WORKSPACE_NAME}"
          
          # Obtain the repo name from the GitHub repository variable
          # GITHUB_REPOSITORY is in the format "Repo-1/"
          REPO_NAME="${GITHUB_REPOSITORY##*/}"

          # Construct the Bitbucket SSH URL
          # "Space-B/Repo-1" in Bitbucket is "Org-A/Repo-1" in Github          
          BITBUCKET_URL="ssh://git@bitbucket.org/${WORKSPACE_NAME}/${REPO_NAME}.git"

          echo "Mirroring to: ${BITBUCKET_URL}"

          # Add the Bitbucket remote         
          git remote add bitbucket "${BITBUCKET_URL}"

          # Push all branches and tags to Bitbucket
          # --mirror pushes all refs; --force ensures diverged histories are overwritten          
          git push bitbucket --all --force
          git push bitbucket --tags --force